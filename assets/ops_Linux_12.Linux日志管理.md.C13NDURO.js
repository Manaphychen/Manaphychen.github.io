import{_ as s,c as i,o as a,aj as t}from"./chunks/framework._AF764y6.js";const c=JSON.parse('{"title":"Linux日志管理","description":"","frontmatter":{"title":"Linux日志管理","date":"2023-10-26T22:46:23.000Z","permalink":"/linux/log/","categories":["运维","Linux"],"tags":["linux"],"author":"Manaphy"},"headers":[],"relativePath":"ops/Linux/12.Linux日志管理.md","filePath":"ops/Linux/12.Linux日志管理.md","lastUpdated":1744977432000}'),n={name:"ops/Linux/12.Linux日志管理.md"},l=t(`<blockquote><p>日志文件是重要的系统信息文件，其中记录了许多重要的系统事件，包括用户的登录信息、系统的启动信息、系统的安全信息、邮件相关信息、各种服务相关信息等。</p><p>日志对于安全来说也很重要，它记录了系统每天发生的各种事情，通过日志来检查错误发生的原因，或者受到攻击时攻击者留下的痕迹。</p><p><strong>日志是用来记录重大事件的工具</strong></p></blockquote><h1 id="系统常用的日志" tabindex="-1">系统常用的日志 <a class="header-anchor" href="#系统常用的日志" aria-label="Permalink to “系统常用的日志”">​</a></h1><p><code>/var/log/</code> 目录就是系统日志文件的保存位置</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@Manaphy log]# ls /var/log/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anaconda</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              cloud-init.log</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                grubby_prune_debug</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  messages-20210110</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  spooler-20201227</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">audit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                 cron</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                          journal</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             messages-20210117</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  spooler-20210103</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot.log</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              cron-20201227</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                 lastlog</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             ntpstats</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           spooler-20210110</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot.log-20191228</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     cron-20210103</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                 maillog</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             rhsm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               spooler-20210117</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot.log-20200207</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     cron-20210110</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                 maillog-20201227</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    sa</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                 tallylog</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot.log-20200208</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     cron-20210117</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                 maillog-20210103</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    secure</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             tuned</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot.log-20200718</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     diagnostic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    maillog-20210110</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    secure-20201227</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    wtmp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">btmp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                  dmesg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                         maillog-20210117</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    secure-20210103</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    yum.log</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">btmp-20210101</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         dmesg.old</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                     messages</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            secure-20210110</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    yum.log-20200101</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chrony</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                ecs_network_optimization.log</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  messages-20201227</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   secure-20210117</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    yum.log-20210101</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloudinit-deploy.log</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  grubby</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        messages-20210103</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   spooler</span></span></code></pre></div><p>系统常用的日志</p><table tabindex="0"><thead><tr><th style="text-align:left;"><strong>日志文件</strong></th><th style="text-align:left;"><strong>说明</strong></th></tr></thead><tbody><tr><td style="text-align:left;">/var/log/boot.log</td><td style="text-align:left;">系统启动日志</td></tr><tr><td style="text-align:left;">/var/log/cron</td><td style="text-align:left;">记录与系统定时任务相关的日志</td></tr><tr><td style="text-align:left;">/var/log/cups</td><td style="text-align:left;">记录打印信息的日志</td></tr><tr><td style="text-align:left;">/var/log/dmesg</td><td style="text-align:left;">记录了系统在开机时内核自检的信息。也可以使用<code>dmesg</code>命令直接查看内核自检信息</td></tr><tr><td style="text-align:left;">/var/log/btmp</td><td style="text-align:left;">记录错误登录的日志。二进制文件，使用<code>lastb</code>命令查看</td></tr><tr><td style="text-align:left;">/var/log/lastlog</td><td style="text-align:left;">记录系统中所有用户最后一次的登录时间的日志。二进制文件，使用<code>lastlog</code>命令查看</td></tr><tr><td style="text-align:left;">var/log/maillog</td><td style="text-align:left;">记录邮件信息的日志</td></tr><tr><td style="text-align:left;">var/log/message</td><td style="text-align:left;">记录系统重要消息的日志，这个日志文件中会记录Linux系统中的绝大多数重要信息。</td></tr><tr><td style="text-align:left;">/var/log/secure</td><td style="text-align:left;">记录验证和授权方面的倍息，只要涉及账户和密码的程序都会记录，比如系统的登录、ssh的登录、su切换用户、sudo授权，甚至添加用户和修改用户密码都会记泉在这个日志文件中</td></tr><tr><td style="text-align:left;">/var/log/wtmp</td><td style="text-align:left;">永久记录所有用户的登陆、注俏信息，同时记录系统的后动、重启、关机事件。二进制文件，使用last命令查看</td></tr><tr><td style="text-align:left;">/var/tun/ulmp</td><td style="text-align:left;">记录当前已经登录的用户的信息。这个文件会随着用户的登录和注销而不断变化，只记录当前登录用户的信息。不能直接查看，而要使用w、who、users等命令查看</td></tr></tbody></table><h1 id="日志管理服务-rsyslogd" tabindex="-1">日志管理服务 rsyslogd <a class="header-anchor" href="#日志管理服务-rsyslogd" aria-label="Permalink to “日志管理服务 rsyslogd”">​</a></h1><blockquote><p>CentOS7.6 日志服务是 rsyslogd , CentOS6.x 日志服务是 syslogd 。rsyslogd 功能更强大。rsyslogd  的使用、日志文件的格式，和 syslogd  服务兼容的。</p></blockquote><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查询 Linux  中的 rsyslogd 服务是否启动</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ps</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aux</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;rsyslog&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;grep&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查询 rsyslogd 服务的自启动状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list-unit-files</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsyslog</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 配置文件位置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/etc/rsyslog.conf</span></span></code></pre></div><p>配置文件内容(部分)</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rsyslog 配置文件</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#### 模块 ####</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ModLoad imuxsock </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 提供对本地系统日志记录的支持 (e.g. via logger command)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ModLoad imjournal </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 提供对systemd日志的访问</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#### 全局指令 ####</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># #放置auxiliary文件的位置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$WorkDirectory /var/lib/rsyslog</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用默认时间戳格式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在/etc/rsyslog.d/中包括所有配置文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$IncludeConfig /etc/rsyslog.d/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 通过本地日志套接字关闭消息接收;现在通过即时新闻检索本地消息.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$OmitLocalLogging on</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 将位置存储在日志中的文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$IMJournalStateFile imjournal.state</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#### 规则 ####</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 将所有内核消息记录到控制台,记录其他内容会使屏幕混乱</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#kern.*                                                 /dev/console</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 记录任何级别信息或更高级别的信息(邮件除外)不要记录私人身份验证消息!</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.info;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mail.none</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authpriv.none</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cron.none</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                /var/log/messages</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># authpriv文件具有受限访问权限.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authpriv.*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                              /var/log/secure</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mail.*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                                                  -/var/log/maillog</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cron.*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                  /var/log/cron</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 每个人都收到紧急消息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.emerg                                                 :omusrmsg:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 将紧急级别或更高级别的新闻错误保存在特殊文件中.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uucp,news.crit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                          /var/log/spooler</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 将启动消息也保存到boot.log</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">local7.*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                /var/log/boot.log</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">!</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">格式为 类型.级别 存放日志文件</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">日志类型:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">auth 									#pam产生的日志</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">authpriv 	 				 	  #ssh ftp 等登录信息的验证信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">corn      					  #时间任务相关</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kern     					    #内核</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">lpr										#打印</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mail									#邮件</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mark(syslog)-rsyslog  #服务内部的信息，时间标识</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">news									#新闻组</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">user									#用户程序产生的相关信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">uucp									#unix	to nuix	copy 主机之间相关的通信</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">local 1-7							#自定义的日志设备</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">日志级别:(从上到下,级别从低到高,记录信息越来越少)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">debug			#有调试信息的，日志通信最多</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">info			#一般信息日志，最常用</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">notice		#最具有重要性的普通条件的信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">warning		#警告级别</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">err				#错误级别，阻止某个功能或者模块不能正常工作的信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">crit			#严重级别，阻止整个系统或者整个软件不能正常工作的信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">alert			#需要立刻修改的信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">emerg			#内核崩溃等重要信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">none			#什么都不记录</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">!</span></span></code></pre></div><p>由日志服务 rsyslogd 记录的日志文件，日志文件的格式包含以下 4  列</p><ol><li>事件产生的时间</li><li>产生事件的服务器的主机名</li><li>产生事件的服务名或程序名</li><li>事件的具体信息</li></ol><h1 id="日志轮替" tabindex="-1">日志轮替 <a class="header-anchor" href="#日志轮替" aria-label="Permalink to “日志轮替”">​</a></h1><blockquote><p>日志轮替就是把旧的日志文件移动并改名，同时建立新的空日志文件，当旧日志文件超出保存的范围之后，就会进行删除</p></blockquote><p><strong>日志轮替文件命名</strong></p><ol><li>centos7 使用 logrotate 进行日志轮替管理，要想改变日志轮替文件名字，通过 /etc/logrotate.conf 配置文件中<code>dateext</code>参数</li><li>如果配置文件中有<code>dateext</code>参数，那么日志会用日期来作为日志文件的后缀，例如<code>secure-20201010</code>。这样日志文件名不会重叠，也就不需要日志文件的改名， 只需要指定保存日志个数，删除多余的日志文件即可。</li><li>如果配置文件中没有<code>dateext</code>参数，日志文件就需要进行改名了。当第一次进行日志轮替时，当前的<code>secure</code>日志会自动改名为<code>secure.1</code>，然后新建<code>secure</code>日志， 用来保存新的日志。当第二次进行日志轮替时，<code>secure.1</code>会自动改名为<code>secure.2</code>， 当前的<code>secure</code>日志会自动改名为<code>secure.1</code>，然后也会新建<code>secure</code>日志，用来保存新的日志，以此类推。</li></ol><p><strong>logrotate 配置文件</strong></p><p><code>/etc/logrotate.conf</code>为 logrotate 的全局配置文件</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># see &quot;man logrotate&quot; for details</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 每周轮换日志文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">weekly</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 共保存4份日志文件(当建立新的日志文件时,旧的将会被删除)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 轮换旧文件后创建新的（空）日志文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用日期作为日志轮替文件的后缀</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dateext</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果要压缩日志文件，请取消注释</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#compress</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># RPM软件包将日志轮换信息拖放到此目录中</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/logrotate.d</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># no packages own wtmp and btmp -- we&#39;ll rotate them here</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/var/log/wtmp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    monthly</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #每月轮替一次日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0664</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> utmp</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #建立的新日志文件,权限是0664,所有者是root,所属组是utmp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        minsize</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1M</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #日志文件最小轮替大小是1M.也就是日志要超过1M才会轮替,否则就算时间达到1个月也不进行日志转储</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    rotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #仅保留一个日志备份.也就是只有wtmp和wtmp.1日志保留</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/var/log/btmp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    missingok</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #如果日志不存在,则忽略该日志的警告信息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    monthly</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> utmp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    rotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 系统特定日志也可以在此处配置</span></span></code></pre></div><table tabindex="0"><thead><tr><th style="text-align:left;"><strong>参数</strong></th><th style="text-align:left;"><strong>说明</strong></th></tr></thead><tbody><tr><td style="text-align:left;">daily</td><td style="text-align:left;">日志的轮替周期是每天</td></tr><tr><td style="text-align:left;">weekly</td><td style="text-align:left;">日志的轮替周期是每周</td></tr><tr><td style="text-align:left;">monthly</td><td style="text-align:left;">日志的轮替周期是每月</td></tr><tr><td style="text-align:left;">rotate 数字</td><td style="text-align:left;">保留的日志文件的个数。0  指没有备份</td></tr><tr><td style="text-align:left;">compress</td><td style="text-align:left;">日志轮替时，旧的日志进行压缩</td></tr><tr><td style="text-align:left;">create mode owner group</td><td style="text-align:left;">建立新日志，同时指定新日志的权限与所有者和所属组。</td></tr><tr><td style="text-align:left;">mail address</td><td style="text-align:left;">当日志轮替时，输出内容通过邮件发送到指定的邮件地址。</td></tr><tr><td style="text-align:left;">missingok</td><td style="text-align:left;">如果日志不存在，则忽略该日志的警告信息</td></tr><tr><td style="text-align:left;">notifempty</td><td style="text-align:left;">如果日志为空文件，则不进行日志轮替</td></tr><tr><td style="text-align:left;">minsize 大小</td><td style="text-align:left;">日志轮替的最小值。也就是日志一定要达到这个最小值才会轮替，否则就算时间达到也不轮替</td></tr><tr><td style="text-align:left;">size 大小</td><td style="text-align:left;">日志只有大于指定大小才进行日志轮替，而不是按照时间轮替。</td></tr><tr><td style="text-align:left;">dateext</td><td style="text-align:left;">使用日期作为日志轮替文件的后缀。</td></tr><tr><td style="text-align:left;">sharedscripts</td><td style="text-align:left;">在此关键字之后的脚本只执行一次。</td></tr><tr><td style="text-align:left;">prerotate/endscript</td><td style="text-align:left;">在日志轮替之前执行脚本命令。</td></tr><tr><td style="text-align:left;">postrotate/endscript</td><td style="text-align:left;">在日志轮替之后执行脚本命令。</td></tr></tbody></table><p><strong>把自己的日志加入日志轮替</strong></p><ol><li>第一种方法是直接在<code>/etc/logrotate.conf</code>配置文件中写入该日志的轮替策略</li><li>第二种方法是在<code>/etc/logrotate.d/</code>目录中新建立该日志的轮替文件，在该轮替文件中写入正确的轮替策略，因为该目录中的文件都会被&quot;include&quot;到主配置文件中，所以也可以把日志加入轮替。</li><li>推荐使用第二种方法，因为系统中需要轮替的日志非常多，如果全都直接写入<code>/etc/logrotate.conf</code>配置文件，那么这个文件的可管理性就会非常差，不利于此文件的维护。</li></ol><p>可参考其他配置文件配置属于自己的配置</p><h1 id="日志轮替机制原理" tabindex="-1">日志轮替机制原理 <a class="header-anchor" href="#日志轮替机制原理" aria-label="Permalink to “日志轮替机制原理”">​</a></h1><blockquote><p>日志轮替之所以可以在指定的时间备份日志，是依赖系统定时任务。在<code>/etc/cron.daily/</code>目录，就会发现这个目录中是有 logrotate 文件(可执行)，logrotate 通过这个文件依赖定时任务执行的。</p></blockquote><h1 id="查看内存日志" tabindex="-1">查看内存日志 <a class="header-anchor" href="#查看内存日志" aria-label="Permalink to “查看内存日志”">​</a></h1><blockquote><p>journalctl 可以查看内存日志 注意:重启后清空</p></blockquote><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #查看全部</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #查看最新3条</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --since</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 19:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --until</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 19:10:10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #查看起始时间到结束时间的日志可加日期</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> err</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #报错日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> verbose</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	#日志详细内容</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> _PID=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1245</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> _COMM=sshd</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	#查看包含这些参数的日志(在详细日志查看)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd</span></span></code></pre></div><h1 id="rsyslog占用内存高" tabindex="-1">rsyslog占用内存高 <a class="header-anchor" href="#rsyslog占用内存高" aria-label="Permalink to “rsyslog占用内存高”">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/rsyslog/imjournal.state</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsyslog</span></span></code></pre></div>`,31),e=[l];function p(h,k,r,d,g,F){return a(),i("div",null,e)}const y=s(n,[["render",p]]);export{c as __pageData,y as default};
